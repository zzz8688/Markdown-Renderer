# 前端 Markdown 渲染器：需求与技术规格（课题概要）

本文档旨在明确“前端 Markdown 渲染器”的核心需求与技术规格。与传统 Markdown 渲染不同，本次项目的核心挑战在于支持大语言模型（LLM）的流式输出（Streaming Output）。

在与大模型交互时，文本并非一次性生成，而是以数据块（Chunk）的形式逐字或逐句地流式返回。这种方式能显著降低用户等待的“首屏时间”，带来更流畅的交互体验。渲染器需要能够渐进式地解析和渲染这些文本流，并在接收到最后一个数据包（包含关闭未闭合标签的“尾包”）时，快速完成最终的 DOM 结构修正，确保页面稳定性和渲染性能。

一个简化的流式示例如下：

## 流式示例（简化）

Chunk 1:

> 这是一段引用...

Chunk 2:

> 这是一段引用...

| 表头1 | 表头2

Chunk 3（尾包）:

> 这是一段引用...

| 表头1 | 表头2 |
| --- | --- |
| 内容1 | 内容2 |

渲染器需在过程中实时展示中间态，并在最后一步根据完整信息高效完成最终渲染。

## 生态参考

当前主流的 Markdown 解析器主要有 marked、markdown-it 和 remark。

- marked：一个轻量级、快速的解析器，但扩展性相对有限。
- markdown-it：功能强大，支持插件，性能优异，是许多知名项目的选择。
- remark (及其生态)：基于 unified 抽象语法树（AST）生态，提供了极高的可扩展性和灵活性。通过插件化的方式，可以精细地控制解析、转换和渲染的每一个环节，非常适合处理复杂的渲染需求，如流式解析、语法扩展和自定义渲染逻辑。

本项目建议采用 remark 技术栈，因为它能更好地支持本次需求的流式处理、语法扩展和精细化渲染控制。推荐使用的核心库包括：

- remark-parse：将 Markdown 解析为 AST。
- remark-gfm：支持 GFM 语法（表格、任务列表等）。
- remark-directive：支持自定义指令语法（如 callout、badge）。
- remark-math：支持数学公式。
- remark-rehype：将 Markdown AST 转换为 HTML AST。
- rehype-katex：使用 KaTeX 渲染数学公式。
- rehype-stringify：将 HTML AST 序列化为 HTML 字符串。

## 功能要求

### 1. 支持平滑的流式渲染（主功能）

说明：渲染器必须能够处理并渲染不完整的 Markdown 文本流。随着数据块的不断送达，页面内容应实现平滑的流式渲染（避免整体刷新或闪烁）。

主流的 AI 应用中，传输数据的格式大多为 HTTP Chunk。由于相对 WebSocket 协议，HTTP Chunk 的相邻两个数据包时间间隔较大、每个 Chunk 块较大，导致用户视角的打字机输出效果较差。为实现最流畅的输出效果，需要将每个 Chunk 的字符按照平滑、合适的速度逐字输出。本文档提出一种速度平滑算法，用于解决上述问题。

建议实现方案：

- 设计一个平滑的流式输出器，负责按照合理的速度逐字输出 Markdown（可参考“弹簧的伸缩运动”进行速度平滑建模）。
- 设计一个 React 组件，根据逐字输出的内容渲染上屏；利用 React 对 DOM 的复用能力避免闪屏。
- 为“尾包”的到达设计特殊逻辑：当尾包到达时，以最快速度逐字渲染上屏并进行最终结构修正。
- 提示：参考《流式渲染设计与实践》（内部链接：https://bytedance.larkoffice.com/wiki/CIYSwotMXiCNvxksY0LcyxfbnWb?from=from_copylink）。

验收标准：

- 能够接收并渲染文本片段，实时更新视图。
- 在接收到“流式尾包”时，能够快速修正文档结构（如从未闭合的列表变为完整的表格），并以最优性能完成最终渲染。
- 渲染过程流畅，无明显的页面重排或性能瓶颈。
- 平滑输出的初始速度、最大速度可调。

### 2. 支持标准及 GFM 语法

说明：支持 Markdown 基本语法以及 GitHub Flavored Markdown (GFM) 的常用扩展。

### 3. 支持数学公式

说明：支持在 Markdown 中编写和渲染数学公式，使用 KaTeX 引擎。

验收标准：

- 正确渲染行内公式（Inline），语法为 `$formula$`。
- 正确渲染块级公式（Block），语法为 `$$formula$$`。

建议实现方案：

- 使用 remark-math 和 rehype-katex 插件进行集成。

### 4. 支持常见语法修复（加分项）

说明：为提升数据流式期间的渲染效果，渲染器可尝试自动修复一些常见的 Markdown 语法笔误。

验收标准：

- 能在流式数据期间自动修复未闭合的代码块（例如，仅有起始的 ``` 而无结尾）。

注意事项：

- 此功能应设计为可选项，用户可以选择开启或关闭。

### 5. 扩展 Directive 语法（加分项）

说明：基于 remark-directive，支持一种可扩展的指令语法，用于创建自定义容器或元素，如警告框、徽章等。

验收标准：

- 支持行内指令，如 `:badge[文字]{type=info}`，可渲染为特定样式的徽章。
- 支持块级指令，如 `:::callout[标题]{type=warning}`，可渲染为带特定背景色和图标的警告框。

渲染约定示例：

- `:badge[新功能]{type=success}` -> `<span class="badge badge-success">新功能</span>`
- 
  ```md
  :::callout[注意]
  内容...
  :::
  ```
  -> `<div class="callout callout-default"><div class="callout-title">注意</div><div class="callout-content">内容...</div></div>`

## Markdown 样张

# 前端 Markdown 渲染器测试样张

这是一个用于测试渲染器功能的综合示例。

## GFM 语法

### 任务列表
- [x] 支持流式渲染
- [x] 支持 GFM 语法
- [x] 支持公式

### 表格
| 功能点 | 优先级 | 负责人 |
| --- | :---: | ---: |
| GFM 支持 | P0 | @sunzhongda |
| 公式渲染 | P1 | @sunzhongda |
| 指令扩展 | P1 | @sunzhongda |

### 脚注
这是一个包含脚注的句子[^1]。

[^1]: 这是脚注的具体内容。

## 公式渲染

当质量 $m$ 的物体以速度 $v$ 运动时，其动能 $E_k$ 由以下公式定义：

$$
E_k = \frac{1}{2}mv^2
$$

这个公式是经典力学的基础。

## 扩展指令（加分项）

你可以使用指令来创建一些特殊的 UI 元素。

这是一个成功状态的徽章 :badge[Success]{type=success}，和一个警告状态的徽章 :badge[Warning]{type=warning}。

:::callout[这是一个提示]
你可以在这里写下需要引起用户注意的详细信息。
- 列表项 1
- 列表项 2
:::

:::callout[危险操作]{type=danger}
这是一个表示危险操作的警告框，请谨慎操作！
:::

以下是一段可用于测试的 Markdown 样张，覆盖了 GFM、公式和扩展指令等多种语法。你可以直接复制到 Playground 中进行测试。

## 产物与验收

### 产物交付

一个公开可访问的 Playground 页面，包含左右两个区域：

- 左侧为 Markdown 输入框。
- 右侧为实时渲染的预览区域。

Playground 的源代码目录。

### 技术选型建议

- 核心库：强烈建议使用 remark 及其生态（unified）进行开发。
- 前端框架：React + Typescript。

### 验收标准

功能验收：

- Playground 页面功能完整，满足上述所有“主功能”要求。
- “加分项”功能按实现情况验收。
- 输入框中的内容变化能实时反映在右侧预览区。
- “Markdown 样张”部分提供的代码能够被正确、完整地渲染。

说明：Playground 的最终访问链接和代码仓库地址将在此处补充。

- Playground 链接：
- 代码目录：

交互验收：

- 页面布局清晰，交互流畅。
- 在输入大量文本或快速输入时，渲染预览无明显延迟或卡顿。
